[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2023-11-07 10:54:00.553491",
  "module": "Ordem Servico",
  "name": "Atualizar status Guia de Remessa",
  "rate_limit_count": 0,
  "rate_limit_seconds": 0,
  "reference_doctype": null,
  "script": "for dn in frappe.get_all(\"Delivery Note\", filters = {\"per_billed\":100, \"workflow_state\":[\"not in\",[\"Concluído\",\"Cancelado\"]],\"docstatus\":1}):\n    \n    frappe.get_doc(\"Delivery Note\",dn.name).update({\"workflow_state\": \"Concluído\"}).save()",
  "script_type": "Scheduler Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-05-08 15:37:03.688986",
  "module": "Ordem Servico",
  "name": "Alteração de status com base na data limite de faturamento",
  "rate_limit_count": 0,
  "rate_limit_seconds": 0,
  "reference_doctype": null,
  "script": "current_day = int(frappe.utils.nowdate().split(\"-\")[2])\nfor dn in frappe.get_all(\"Delivery Note\", filters={\"status\": \"To Bill\", \"data_limite_de_faturamento\": (\">\", current_day), \"docstatus\": 1}): \n    frappe.get_doc(\"Delivery Note\", dn.name).update({\"status\": \"Em Espera\"}).save()\n    \n'''for dn in frappe.get_all(\"Delivery Note\", filters={\"status\": \"Em Espera\", \"data_limite_de_faturamento\": (\">=\", current_day), \"docstatus\": 1}): \n    frappe.get_doc(\"Delivery Note\", dn.name).update({\"status\": \"To Bill\"}).save()'''\n\n# Mover notas de entrega \"Em Espera\" com data limite no dia atual ou posterior para \"Para Faturar\"\n'''\nfor dn in frappe.get_all(\"Delivery Note\", filters={\"workflow_state\": \"Em Espera\", \"data_limite_de_faturamento\": (\">=\", current_day), \"docstatus\": 1}): \n    try:\n        doc = frappe.get_doc(\"Delivery Note\", dn.name)\n        sales_order_name = doc.sales_order  # Obtém o Sales Order vinculado\n\n        # Atualiza o estado da Delivery Note\n        doc.update({\"workflow_state\": \"Para Faturar\"}).save()\n\n        # Atualiza o campo per_delivered no Sales Order vinculado\n        update_per_delivered(sales_order_name)\n\n    except Exception as e:\n        # Log ou customize a mensagem de erro aqui\n        frappe.msgprint(f\"Erro ao atualizar a nota de entrega {dn.name}: {e}\")\n        \n        \ndef update_per_delivered(sales_order_name):\n    # Função para atualizar o campo per_delivered no Sales Order\n    \n    so = frappe.get_doc(\"Sales Order\", sales_order_name)\n    \n    # Obtém todas as Delivery Notes vinculadas ao Sales Order\n    delivery_notes = frappe.get_all(\n        \"Delivery Note\",\n        filters={\"sales_order\": so.name, \"workflow_state\": \"Para Faturar\", \"docstatus\": 1}\n    )\n    \n    total_entregue = 0\n    total_pedido = sum([item.qty for item in so.items])\n\n    for dn in delivery_notes:\n        # Obtém a Delivery Note\n        delivery_note = frappe.get_doc(\"Delivery Note\", dn.name)\n        \n        # Soma as quantidades entregues\n        total_entregue += sum([item.qty for item in delivery_note.items])\n\n    if total_pedido > 0:\n        porcentagem_entrega = (total_entregue / total_pedido) * 100\n    else:\n        porcentagem_entrega = 0\n\n    # Ajuste: Limita a porcentagem_entrega a 100%\n    so.per_delivered = min(porcentagem_entrega, 100)\n    so.save()\n    '''\n    \n\n\n\n\n'''for dn in frappe.get_all(\"Delivery Note\", filters={\"workflow_state\": \"Para Faturar\", \"data_limite_de_faturamento\": (\"<\", current_day), \"docstatus\": 1}): \n    frappe.get_doc(\"Delivery Note\",dn.name).update({\"workflow_state\": \"Em Espera\"}).save()'''\n\n''''''",
  "script_type": "Scheduler Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-01-08 13:34:30.250315",
  "module": "Ordem Servico",
  "name": "Validação para quando o faturamento parcial for igual a \"Não\"",
  "rate_limit_count": 0,
  "rate_limit_seconds": 0,
  "reference_doctype": null,
  "script": "for dn in frappe.get_all(\"Delivery Note\", filters={\"workflow_state\": \"Em Espera\", \"faturamento_parcial\": \"NÃO\", \"docstatus\": 1}):\n    delivery_note = frappe.get_doc(\"Delivery Note\", dn.name)\n    sales_order_name = delivery_note.reference_name\n\n    # Obtém o campo per_delivered da Sales Order\n    per_delivered = frappe.db.get_value(\"Sales Order\", sales_order_name, \"per_delivered\")\n\n    if per_delivered == 100:\n        # Atualiza o workflow_state para \"Para Faturar\" na Delivery Note\n        delivery_note.workflow_state = \"Para Faturar\"\n        delivery_note.bypass_workflow = True\n        delivery_note.save()\n\n        # Impede que o valor de per_delivered na Sales Order seja recalculado\n        frappe.db.set_value(\"Sales Order\", sales_order_name, \"per_delivered\", per_delivered)\n",
  "script_type": "Scheduler Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "Daily",
  "modified": "2024-08-15 10:18:20.209656",
  "module": "Ordem Servico",
  "name": "Validacao Status",
  "rate_limit_count": 0,
  "rate_limit_seconds": 0,
  "reference_doctype": null,
  "script": "# Obtém a data atual como string no formato \"YYYY-MM-DD\"\ndata_atual = frappe.utils.nowdate()\n\n# Filtra colaboradores ativos\nfor dn in frappe.get_all(\"Employee\", filters={\"status\": \"Active\"}):\n    employee = frappe.get_doc(\"Employee\", dn.name)\n    \n    # Verifica se há linhas na tabela filha \"documentos_internos\" com status \"Em dia\"\n    documentos_em_dia = [doc for doc in employee.get(\"documentos_internos\") if doc.status == \"Em dia\"]\n    \n    if documentos_em_dia:\n        # Percorre a tabela filha \"documentos_internos\"\n        for doc in documentos_em_dia:\n            # Verifica se a data de validade é menor que a data atual\n            if frappe.utils.get_datetime(doc.data_validade) < frappe.utils.get_datetime(data_atual):\n                # Atualiza o campo \"status\" para \"Vencido\"\n                doc.status = \"Vencido\"\n        \n        # Ignora campos obrigatórios e salva o colaborador\n        employee.flags.ignore_mandatory = True\n        employee.save()\n \n        # Confirma as alterações no banco de dados\n        frappe.db.commit()\n",
  "script_type": "Scheduler Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "Daily",
  "modified": "2025-06-04 09:27:16.628131",
  "module": "Ordem Servico",
  "name": "Executar envio de notificacoes faturas vencidas",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "hoje = frappe.utils.nowdate()  # formato 'YYYY-MM-DD'\n\nfaturas = frappe.get_all(\n    \"Sales Invoice\",\n    filters={\n        \"docstatus\": 1,\n        \"outstanding_amount\": [\">\", 0],\n        \"due_date\": [\"<\", hoje]\n    },\n    fields=[\"name\"]\n)\n\nfor fatura_data in faturas:\n    fatura = frappe.get_doc(\"Sales Invoice\", fatura_data.name)\n\n    for linha in fatura.custom_notificacao_de_fatura_vencida:\n        email = linha.email_notificacao_fatura  # pega o campo de e-mail\n        if email:\n            # Envia um e-mail de teste\n            frappe.sendmail(\n                recipients=email,\n                subject=f\"Teste de notificação - Fatura {fatura.name}\",\n                message=f\"Esta é uma notificação de teste referente à fatura {fatura.name}, com vencimento em {fatura.due_date}.\",\n                reference_doctype=\"Sales Invoice\",\n                reference_name=fatura.name\n            )\n            \n        linha.enviado = \"9999999\"  # ou 1, se o campo for tipo Check\n\n    fatura.save()\n    frappe.db.commit()\n",
  "script_type": "Scheduler Event"
 }
]